<html>
  <head>
    <link rel="stylesheet" href="style.css" media="screen"charset="utf-8">
    <script src="https://code.createjs.com/createjs-2015.11.26.min.js"></script>
    <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script type="text/javascript" src="javascript.js"></script>
    <!-- <script type="text/javascript" src="recorder.js"></script> -->
    <link href='https://fonts.googleapis.com/css?family=Orbitron' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <script>
      var samples_list = [
        "kick-808",
        "clap",
        "snare-vinyl01",
        "kick-vinyl01",
        "hihat-plain",
        "snare-block",
        "snare-noise",
        "shaker-shuffle",
        "tom-analog"
      ]

      var metronomeSounds = [
        "metronome1",
        "metronome2"
      ]

      var music_background = "hh-track";

      function loadSound () {
        createjs.Sound.registerSound("samples_list/drum-kits/kick-808.wav", 0);
        createjs.Sound.registerSound("samples_list/drum-kits/snare-vinyl01.wav", 1);
        createjs.Sound.registerSound("samples_list/drum-kits/clap.wav", 2);
        createjs.Sound.registerSound("samples_list/drum-kits/kick-vinyl01.wav", 3);
        createjs.Sound.registerSound("samples_list/drum-kits/hihat-plain.wav", 4);
        createjs.Sound.registerSound("samples_list/drum-kits/snare-block.wav", 5);
        createjs.Sound.registerSound("samples_list/drum-kits/snare-noise.wav", 6);
        createjs.Sound.registerSound("samples_list/drum-kits/shaker-shuffle.wav", 7);
        createjs.Sound.registerSound("samples_list/drum-kits/tom-analog.wav", 8);
        createjs.Sound.registerSound("samples_list/metronome/metronome1.wav", 9);
        createjs.Sound.registerSound("samples_list/metronome/metronome2.wav", 10);
        createjs.Sound.registerSound("http://res.cloudinary.com/codehunt/video/upload/v1457576486/Hip_Hop_Drumless_Backing_Track_vkxnzk.mp3", music_background);
      }

      function playSound (idx) {
        createjs.Sound.play(idx);
      }

      function playTrack() {
        createjs.Sound.play(music_background);
      }

      function stopTrack() {
        createjs.Sound.stop();
      }

      var isPlaying = false;
      var isRecording = false;
      var startTime = null;
      var timeOut;
      var tickCount;
      var ctsPerBeat = 200; // == 90bpm
      var toAdd = [];
      var master = {1: {}, 2: {}, 3: {}, 4: {} };
      var metronomeOn = true;
      var track = 1;

      for (var i = 0; i < ctsPerBeat; i++) {
        master[1][i] = [];
        master[2][i] = [];
        master[3][i] = [];
        master[4][i] = [];
      }

      function playLoop(){
        var time = tickCount % ctsPerBeat;
        [1, 2, 3, 4].forEach(function(i){
          master[i][time].forEach (function(i){
            playSound(i);
          })
        })
      };

      function stopLoop(){
        var time = tickCount % ctsPerBeat;
        [1, 2, 3, 4].forEach(function(i){
          master[i][time].forEach (function(i){
              createjs.Sound.stop(i);
          })
        })
        metronomeOn = false;
      };

      $(document).bind("keyup", function(event){
        if (event.keyCode === 79) {
          stopLoop();
        }
      });

      $(document).bind("keyup", function(event){
        if (event.keyCode === 80) {
          playLoop();
        }
      });




      function metronome(time){
        if (metronomeOn){
          if (time === 0) {
            playSound(9);
          } else if ([51, 101, 151].indexOf(time) > -1) {
            playSound(10);
          }
        }
      }

      function advanceClock() {
        var time = tickCount % ctsPerBeat;
        // console.log(time);
        metronome(time);

        if (isRecording) {
          master[track][time] = toAdd;
          toAdd = [];
        }
        [1, 2, 3, 4].forEach(function(j){
          master[j][time].forEach (function(i){
            playSound(i);
          })
        })
        tickCount += 1;
      }

      var handleRecord = function() {
          isRecording = true;
          startPlaying();
      }

      var startPlaying = function(){
        if (!isPlaying) {
          isPlaying = true;
          startTime = new Date();
          tickCount = 0;
          advanceClock();
          timeOut = setInterval(advanceClock, 10);
        }
      }

      function toggleMetronome(){
        metronomeOn = !metronomeOn;
      }

      function stopRecording(){
        isRecording = false;
      }

      var handleNote = function (idx){
        playSound(idx);
      }

      function setTrack(i){
        track = i;
        isRecording = false;
        handleRecord();
        debugger
        for (var j = 1; j < 5; j++) {
          debugger
          if (j === i) {
            $("#track" + i.toString()).addClass("track-selected");
            [1, 2, 3, 4].forEach(function(k){
              if (k !== i){
                $("#track" + k.toString()).removeClass("track-selected");
              }
            })
          }
        }
      }

      $(document).bind("keydown", function(event){
        switch (event.keyCode){
          case 49:
            setTrack(1);
            break;
          case 50:
            setTrack(2);
            break;
          case 51:
            setTrack(3);
            break;
          case 52:
            setTrack(4);
            break;
        }
      });


      $(document).bind("keydown", function(event){
        if (event.keyCode == 32 && isRecording == true) {
          stopRecording();
        } else if (event.keyCode == 32 && isRecording == false) {
          handleRecord();
        }
      });


    </script>
  </head>
  <body onload="loadSound();">

        <div class="mpc-container">
          <div id="mpc-border-left">
          </div>

          <div class="pads-container">
            <div class="under-pads-container">

              <div class="container-single-pad" id="container-pad-1">
                <div onclick="handleNote(0);" class="note-key" id="pad1">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

              <div class="container-single-pad" id="container-pad-2">
                <div onclick="handleNote(1);" class="note-key" id="pad2">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

              <div class="container-single-pad" id="container-pad-3">
                <div onclick="handleNote(2);" class="note-key" id="pad3">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

              <div class="container-single-pad" id="container-pad-4">
                <div onclick="handleNote(3);" class="note-key" id="pad4">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

              <div class="container-single-pad" id="container-pad-5">
                <div onclick="handleNote(4);" class="note-key" id="pad5">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

              <div class="container-single-pad" id="container-pad-6">
                <div onclick="handleNote(5);" class="note-key" id="pad6">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

              <div class="container-single-pad" id="container-pad-7">
                <div onclick="handleNote(6);" class="note-key" id="pad7">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

              <div class="container-single-pad" id="container-pad-8">
                <div onclick="handleNote(7);" class="note-key" id="pad8">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

              <div class="container-single-pad" id="container-pad-9">
                <div onclick="handleNote(8);" class="note-key" id="pad9">
                  <div class="lightening-dot">

                  </div>
                </div>
              </div>

            </div>
          </div>


          <!-- infos box on the right -->
          <div class="infos-box-wrapper">
            <div class="infos-box">
              <div class="screen">
                <p class="screen-text">90 bpm</p>
              </div>
              <audio id="music" preload="true">
                <source src="http://res.cloudinary.com/codehunt/video/upload/v1457576486/Hip_Hop_Drumless_Backing_Track_vkxnzk.mp3">
                  <source src="http://res.cloudinary.com/codehunt/video/upload/v1457576624/Hip_Hop_Drumless_Backing_Track_oiamzk.ogg">
                  </audio>
                  <div id="audioplayer">
                    <i onclick="playTrack();" class="fa fa-play fa-2x play"></i>
                    <i onclick="stopTrack();"  class="fa fa-stop fa-2x stop"></i>
                  </div>
              <div class="volumes-container-fuck-red">
                <ul class="style-btn-container">

                  <li id="hh-btn" class="hh-style-btn">
                      <p class="lighty-dot-hh"></p>
                    </a>
                  </li>
                  <p id="hh">HIP-HOP</p>

                  <li id="tech-btn" class="tech-style-btn">
                      <p class="lighty-dot-techno"></p>
                    </a>
                  </li>
                  <p class="tech">TECHNO</p>
                  <p class="tech">(soon)</p>

                </ul>

                <div class="help-wrapper">
                  <div class="onoffswitch">
                    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch">
                    <label class="onoffswitch-label" for="myonoffswitch"></label>
                  </div>
                  <p id="help-btn">
                    Display Help
                  </p>
                </div>

            </div>
          </div>
        </div>
        <div id="mpc-border-right">
        </div>
      </div>



    <!-- Multitrack recorder -->
    <section class="multitrack-recorder">

      <ul class="trackMonitor">
        <li id="track1" class="tracks" onclick="setTrack(1);"><i class="fa fa-volume-up volume-icon"></i>Track1</li>
        <li id="track2" class="tracks" onclick="setTrack(2);"><i class="fa fa-volume-up volume-icon"></i>Track2</li>
        <li id="track3" class="tracks" onclick="setTrack(3);"><i class="fa fa-volume-up volume-icon"></i>Track3</li>
        <li id="track4" class="tracks" onclick="setTrack(4);"><i class="fa fa-volume-up volume-icon"></i>Track4</li>
      </ul>

      <div class="record-btns">
        <!-- <button onclick="handleRecord();" type="button" name="record">Start recording</button>
        <br>
        <button onclick="stopRecording();" type="button" name="record">Stop recording</button>
        <br> -->

        <button class="play-loop-btn" type="button" name="stopLoop" onclick="stopLoop()">STOP LOOP</button>
        <button class="stop-loop-btn" type="button" name="playLoop" onclick="playLoop()">PLAY LOOP</button>


        <div class="metronome-wrapper">
          <div class="onoffswitch">
            <input onclick="toggleMetronome();" type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="metronome-onoffswitch">
            <label class="onoffswitch-label" for="metronome-onoffswitch"></label>
          </div>
          <br>
          <img src="/images/metronome.png" id="metronome-img" />

      </div>
    </section>

  </body>
</html>
